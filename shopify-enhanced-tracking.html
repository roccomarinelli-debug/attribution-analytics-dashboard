<!-- Enhanced Shopify Tracking Script -->
<!-- Place this in theme.liquid just before </head> -->

<script>
(function() {
  const API_URL = 'https://attribution-analytics-dashboard.vercel.app/api/tracking';

  function getSessionId() {
    let sessionId = sessionStorage.getItem('attribution_session_id');
    if (!sessionId) {
      sessionId = 'sess_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      sessionStorage.getItem('attribution_session_id', sessionId);
    }
    return sessionId;
  }

  function getVisitorId() {
    let visitorId = localStorage.getItem('attribution_visitor_id');
    if (!visitorId) {
      visitorId = 'visitor_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      localStorage.setItem('attribution_visitor_id', visitorId);
    }
    return visitorId;
  }

  function track(eventName, data = {}) {
    fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        event: eventName,
        sessionId: getSessionId(),
        visitorId: getVisitorId(),
        timestamp: new Date().toISOString(),
        ...data
      })
    }).catch(err => console.error('Tracking error:', err));
  }

  // Track page view
  track('page_view', {
    pageUrl: window.location.href,
    pageTitle: document.title,
    referrer: document.referrer
  });

  // Track add to cart
  document.addEventListener('DOMContentLoaded', function() {
    const addToCartForms = document.querySelectorAll('form[action*="/cart/add"]');
    addToCartForms.forEach(form => {
      form.addEventListener('submit', function(e) {
        const productId = form.querySelector('[name="id"]')?.value;
        const quantity = form.querySelector('[name="quantity"]')?.value || 1;

        track('add_to_cart', {
          pageUrl: window.location.href,
          productId: productId,
          quantity: parseInt(quantity)
        });
      });
    });

    // Track add to cart button clicks (alternative method)
    const addToCartButtons = document.querySelectorAll('[name="add"], .add-to-cart, [type="submit"][value*="Add"]');
    addToCartButtons.forEach(button => {
      button.addEventListener('click', function() {
        track('add_to_cart_click', {
          pageUrl: window.location.href,
          buttonText: this.textContent || this.value
        });
      });
    });
  });

  // Track navigation/exit page
  let startTime = Date.now();
  window.addEventListener('beforeunload', function() {
    const timeOnPage = Math.floor((Date.now() - startTime) / 1000);
    track('page_exit', {
      pageUrl: window.location.href,
      timeOnPage: timeOnPage,
      nextPage: document.activeElement?.href || 'closed'
    });
  });

  // Track time on page every 30 seconds
  setInterval(function() {
    const timeOnPage = Math.floor((Date.now() - startTime) / 1000);
    track('time_on_page', {
      pageUrl: window.location.href,
      timeOnPage: timeOnPage
    });
  }, 30000);

  // Track checkout initiation
  if (window.location.pathname.includes('/checkout')) {
    track('checkout_started', {
      pageUrl: window.location.href
    });
  }

  // Track product views
  if (window.location.pathname.includes('/products/')) {
    const productName = document.querySelector('.product-title, h1')?.textContent?.trim();
    track('product_view', {
      pageUrl: window.location.href,
      productName: productName
    });
  }

  // Track collection/category views
  if (window.location.pathname.includes('/collections/')) {
    const collectionName = document.querySelector('.collection-title, h1')?.textContent?.trim();
    track('collection_view', {
      pageUrl: window.location.href,
      collectionName: collectionName
    });
  }

  // Track scroll depth
  let maxScrollDepth = 0;
  window.addEventListener('scroll', function() {
    const scrollPercent = Math.round((window.scrollY + window.innerHeight) / document.documentElement.scrollHeight * 100);
    if (scrollPercent > maxScrollDepth) {
      maxScrollDepth = scrollPercent;
      if (scrollPercent >= 25 && scrollPercent < 50) {
        track('scroll_depth', { depth: 25, pageUrl: window.location.href });
      } else if (scrollPercent >= 50 && scrollPercent < 75) {
        track('scroll_depth', { depth: 50, pageUrl: window.location.href });
      } else if (scrollPercent >= 75 && scrollPercent < 100) {
        track('scroll_depth', { depth: 75, pageUrl: window.location.href });
      } else if (scrollPercent >= 100) {
        track('scroll_depth', { depth: 100, pageUrl: window.location.href });
      }
    }
  });
})();
</script>